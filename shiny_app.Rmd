---
title: "R Notebook"
output: html_notebook
---

```{r}
library(shiny)
library(RMySQL)
library(tidyverse)
library(shinydashboard)
library(dashboardthemes)
```

```{r}
### creating custom theme object
theme_lapop <- shinyDashboardThemeDIY(
  
    ### general
    appFontFamily = "Arial"
    ,appFontColor = "rgb(0,0,0)"
    ,primaryFontColor = "rgb(0,0,0)"
    ,infoFontColor = "rgb(0,0,0)"
    ,successFontColor = "rgb(0,0,0)"
    ,warningFontColor = "rgb(0,0,0)"
    ,dangerFontColor = "rgb(0,0,0)"
    ,bodyBackColor = "rgb(248,248,248)"
  
    ### header
    ,logoBackColor = "rgb(0,86,95)"
  
    ,headerButtonBackColor = "rgb(238,238,238)"
    ,headerButtonIconColor = "rgb(75,75,75)"
    ,headerButtonBackColorHover = "rgb(210,210,210)"
    ,headerButtonIconColorHover = "rgb(0,0,0)"
  
    ,headerBackColor = "rgb(238,238,238)"
    ,headerBoxShadowColor = "#aaaaaa"
    ,headerBoxShadowSize = "2px 2px 2px"
  
    ### sidebar
    ,sidebarBackColor = cssGradientThreeColors(
      direction = "down"
      ,colorStart = "rgb(82,136,143)"
      ,colorMiddle = "rgb(82,136,143)"
      ,colorEnd = "rgb(82,136,143)"
      ,colorStartPos = 0
      ,colorMiddlePos = 50
      ,colorEndPos = 100
    )
    ,sidebarPadding = 0
  
    ,sidebarMenuBackColor = "transparent"
    ,sidebarMenuPadding = 0
    ,sidebarMenuBorderRadius = 0
  
    ,sidebarShadowRadius = "3px 5px 5px"
    ,sidebarShadowColor = "#aaaaaa"
  
    ,sidebarUserTextColor = "rgb(255,255,255)"
  
    ,sidebarSearchBackColor = "rgb(55,72,80)"
    ,sidebarSearchIconColor = "rgb(153,153,153)"
    ,sidebarSearchBorderColor = "rgb(55,72,80)"
  
    ,sidebarTabTextColor = "rgb(255,255,255)"
    ,sidebarTabTextSize = 13
    ,sidebarTabBorderStyle = "none none solid none"
    ,sidebarTabBorderColor = "rgb(35,106,135)"
    ,sidebarTabBorderWidth = 1
  
    ,sidebarTabBackColorSelected = cssGradientThreeColors(
      direction = "right"
      ,colorStart = "rgb(0,86,95)"
      ,colorMiddle = "rgb(0,86,95)"
      ,colorEnd = "rgb(0,86,95)"
      ,colorStartPos = 0
      ,colorMiddlePos = 30
      ,colorEndPos = 100
    )
    ,sidebarTabTextColorSelected = "rgb(255,255,255)"
    ,sidebarTabRadiusSelected = "5px 5px 5px 5px"
  
    ,sidebarTabBackColorHover = cssGradientThreeColors(
      direction = "right"
      ,colorStart = "rgb(0,86,95)"
      ,colorMiddle = "rgb(0,86,95)"
      ,colorEnd = "rgb(0,86,95)"
      ,colorStartPos = 0
      ,colorMiddlePos = 30
      ,colorEndPos = 100
    )
    ,sidebarTabTextColorHover = "rgb(255,255,255)"
    ,sidebarTabBorderStyleHover = "none none solid none"
    ,sidebarTabBorderColorHover = "rgb(75,126,151)"
    ,sidebarTabBorderWidthHover = 1
    ,sidebarTabRadiusHover = "5px 5px 5px 5px"
  
    ### boxes
    ,boxBackColor = "rgb(255,255,255)"
    ,boxBorderRadius = 5
    ,boxShadowSize = "0px 1px 1px"
    ,boxShadowColor = "rgba(0,0,0,.1)"
    ,boxTitleSize = 16
    ,boxDefaultColor = "rgb(210,214,220)"
    ,boxPrimaryColor = "rgba(44,222,235,1)"
    ,boxInfoColor = "rgb(210,214,220)"
    ,boxSuccessColor = "rgba(0,255,213,1)"
    ,boxWarningColor = "rgb(244,156,104)"
    ,boxDangerColor = "rgb(255,88,55)"
  
    ,tabBoxTabColor = "rgb(255,255,255)"
    ,tabBoxTabTextSize = 14
    ,tabBoxTabTextColor = "rgb(0,0,0)"
    ,tabBoxTabTextColorSelected = "rgb(0,0,0)"
    ,tabBoxBackColor = "rgb(255,255,255)"
    ,tabBoxHighlightColor = "rgb(0,86,95)"
    ,tabBoxBorderRadius = 5
  
    ### inputs
    ,buttonBackColor = "rgb(245,245,245)"
    ,buttonTextColor = "rgb(0,0,0)"
    ,buttonBorderColor = "rgb(200,200,200)"
    ,buttonBorderRadius = 5
  
    ,buttonBackColorHover = "rgb(235,235,235)"
    ,buttonTextColorHover = "rgb(100,100,100)"
    ,buttonBorderColorHover = "rgb(200,200,200)"
  
    ,textboxBackColor = "rgb(255,255,255)"
    ,textboxBorderColor = "rgb(200,200,200)"
    ,textboxBorderRadius = 5
    ,textboxBackColorSelect = "rgb(245,245,245)"
    ,textboxBorderColorSelect = "rgb(200,200,200)"
  
    ### tables
    ,tableBackColor = "rgb(255,255,255)"
    ,tableBorderColor = "rgb(240,240,240)"
    ,tableBorderTopSize = 1
    ,tableBorderRowSize = 1
  
  )
```



```{r}
## app.R ##

header <- dashboardHeader(title = "Loan Dashboard", titleWidth = 300)



sidebar <- dashboardSidebar(
  width = 300,
  sidebarMenuOutput("sidebar")
)



body <- dashboardBody(

  tabItems(
    tabItem(tabName = "overview",
            # Boxes need to be put in a row (or column)
            fluidRow(
            box(title = "Survey Demographics",
                "This page shows the overall demographics of respondents of the overall survey. Note that this does not reflect the demographics of those who answered a selected topic or question.",
                solidHeader = TRUE, 
                collapsible = TRUE,
                width = 12)
          ),
            fluidRow(
                  # Dynamic valueBoxes
                  valueBoxOutput("numberBox"),
                  valueBoxOutput("femalepercentBox"),
                  valueBoxOutput("ageBox")
                ),
            fluidRow(
              tabBox(title="Histogram of Respondents' age",
                     tabPanel("Overall",  plotOutput("overview_hist")),
                     tabPanel("Gender",  plotOutput("overview_hist_gender"))
                   ),
              tabBox(title="Density of Respondents' age",
                     tabPanel("Overall",  plotOutput("overview_density")),
                     tabPanel("Gender",  plotOutput("overview_density_gender"))
                   ),
  
              box(title = "Total number of respondents each year",
                  plotOutput("overview_year"),
                  solidHeader = TRUE,
                  collapsible = TRUE),
              box(title = "Female ratio of respondents each year", 
                  plotOutput("overview_gender_year"),
                  solidHeader = TRUE,
                  collapsible = TRUE) #,
              box(solidHeader = TRUE,
                  collapsible = TRUE,
                  title = "Box content here", br(), "More box content",
                  sliderInput("slider", "Slider input:", 1, 100, 50),
                  textInput("text", "Text input:")
                  )
              )
            ),
    
    
  tabItem(tabName = "basic",
          fluidRow(
            box(title = "Basic Analysis", #br(), 
                "Basic Analysis is about the background of a specific question, such as the count of different answers, the difference in answers across ages, and the distribution of answers.",
                solidHeader = TRUE, 
                collapsible = TRUE),
            box(title = "Question Introduction:", #br(), 
                "There is an introduction about the topic and the question selected before, which we do not have the information yet.",
                solidHeader = TRUE, 
                collapsible = TRUE)
          ),
          fluidRow(
                  # Dynamic valueBoxes
                  valueBoxOutput("basic_scaleBox"),
                  valueBoxOutput("basic_meanBox"),
                  valueBoxOutput("basic_modeBox")
                ),
          fluidRow(
            tabBox(title="Distribution of Answers",
                   tabPanel("Overall",  plotOutput("basic_scorehist")),
                   tabPanel("Gender",  plotOutput("basic_scorehist_gender"))
                   ),
            tabBox(title="Average Answer for Each Age",
                   tabPanel("Overall",  plotOutput("basic_agedist")),
                   tabPanel("Gender",  plotOutput("basic_agedist_gender"))
                   ),
            box(title = "Boxplot of Gender",
                plotOutput("basic_genderscore"),
                solidHeader = TRUE,
                collapsible = TRUE)#,
            #box(textOutput("basic_question1"))
            
          ),
          fluidRow(
            box(title = "Original table:",
                tableOutput("basic_table"),
                solidHeader = TRUE,
                collapsible = TRUE)
            )
          )

  )
)
```


```{r}
conn <- dbConnect(MySQL(), 
                  dbname = "my_guitar_shop", 
                  username="root", 
                  password="root",
                  host='127.0.0.1',
                  port = 3306,
                  client.flag=CLIENT_MULTI_STATEMENTS)
data = dbGetQuery(conn, "SELECT * FROM products")
dbDisconnect(conn)
```

```{r}
ui <- dashboardPage(header, sidebar, body,
                    theme_lapop)

server <- function(input, output) {
  
  # Sidebar
  output$sidebar <- renderMenu({
    sidebarMenu(
      selectInput("country", "Choose countries:", country, selected = "Canada", multiple = TRUE),
      selectInput("year", "Choose year:", year, selected = c(2014,2016,2018), multiple = TRUE),
      selectInput("topic1", "Choose topic:", topic, selected = "Democracy", multiple = FALSE),
      selectInput("question1", "Choose question:", questions[input$topic1], multiple = FALSE),
      menuItem("Survey Demographics", tabName = "overview", icon = icon("dashboard")),
      menuItem("Basic Analysis", tabName = "basic", icon = icon("chart-bar")),
      menuItem("Time Series Analysis", tabName = "timeseries", icon = icon("chart-line")),
      menuItem("Cross Analysis", tabName = "cross", icon = icon("th")),
      menuItem("Download Data", icon = icon("download"), href = "http://lapop.ccp.ucr.ac.cr/en/")

    )
  })
  
  # Overview
  output$numberBox <- renderValueBox({
    df <- data %>% 
      filter(year %in% input$year,
             country %in% input$country)
    
    valueBox(nrow(df), "Respondents", icon = icon("users"),color = "olive")
  })
  
  output$overview_hist <- renderPlot({
    data %>% 
      filter(year %in% input$year,
             country %in% input$country) %>% 
      ggplot()+
      geom_bar(aes(x=age),width = 1, fill = "#1C6771")+
      theme_classic()+  
      theme(legend.position = "top")
  })
  
  output$overview_hist_gender <- renderPlot({
    data %>% 
      filter(year %in% input$year,
             country %in% input$country) %>% 
      ggplot()+
      geom_bar(aes(x=age,fill=gender), width = 1, position = "dodge")+
      theme_classic()+  
      theme(legend.position = "top")
  })

  

  
  
  # Basic
  
  output$basic_question1 <- renderText({
    question1 <- input$question1
    question1
  })
  
  
  output$basic_scaleBox <- renderValueBox({
    question1 <- input$question1
    df <- data %>% 
      filter(year %in% input$year,
             country %in% input$country) %>% 
      select(question1)
    valueBox(paste0(min(unique(as.matrix(df))), " - ",max(unique(as.matrix(df)))), "Answer Scale", icon = icon("list-ol"),color = "olive")
  })
  
  
  
  output$basic_scorehist <- renderPlot({
    question1 <- input$question1
    data %>% 
      filter(year %in% input$year,
             country %in% input$country) %>% 
      group_by(!!as.symbol(question1), gender) %>% 
      summarise(number = n()) %>% 
      ggplot() +
      geom_col(aes(x = !!as.symbol(question1), y=number), width = 0.7, fill = "#1C6771") +
      # geom_smooth(aes(x = !!as.symbol(question1), y=number),se = FALSE, color = "lightblue", lwd = 2)+
      theme_classic()+
      labs(title = paste0("Distribution for ", question1), x="Answer")+
      theme(legend.position = "top")
  })
  
  
  
  output$time_heatplot <- renderPlot({
    question1 <- input$question1
    
    filter_data <- data %>% 
      filter(year %in% input$year,
             country %in% input$country) 
    whole_number <- nrow(filter_data)
    
    data %>% 
      filter(year %in% input$year,
             country %in% input$country) %>% 
      group_by(!!as.symbol(question1), year) %>%
      summarise(number = n()/whole_number) %>% 
      ggplot(aes(as.factor(!!as.symbol(question1)), as.factor(year)))+
      geom_tile(aes(fill = number), color = "white")+
      geom_text(aes(label = paste0(round(number*100, digits = 2), "%")),color = "white",check_overlap = TRUE)+
      theme_minimal()+
      labs(x=question1, y="Year")+
      theme(legend.position = "none")+
      scale_fill_gradient(low = "white",high = "#1C6771")
  })
  
  
  #Cross
  output$cross_select <- renderUI({
    selectInput("question2",
                "Choose question for cross:",
                questions[input$topic2], 
                selected = "Quality of Municipal Services", 
                multiple = FALSE)
  })
  

  output$cross_heatplot <- renderPlot({
    question1 <- input$question1
    question2 <- input$question2
    
    filter_data <- data %>% 
      filter(year %in% input$year,
             country %in% input$country) 
    whole_number <- nrow(filter_data)
    
    data %>% 
      filter(year %in% input$year,
             country %in% input$country) %>% 
      group_by(!!as.symbol(question1), !!as.symbol(question2)) %>%
      summarise(number = n()/whole_number) %>% 
      ggplot(aes(as.factor(!!as.symbol(question1)), as.factor(!!as.symbol(question2))))+
      geom_tile(aes(fill = number), color = "white")+
      geom_text(aes(label = paste0(round(number*100, digits = 2), "%")),color = "white",check_overlap = TRUE)+
      theme_minimal()+
      labs(x=question1, y=question2)+
      theme(legend.position = "none")+
      scale_fill_gradient(low = "white",high = "#1C6771")

  })
  
  
}
```

```{r}
shinyApp(ui, server)
```

